# 单线程、并发服务器

解释单线程、并发服务器原理，并提供demo 演示。

## 用单线程进行数据驱动处理

想象一个单服务器线程，它打开了到许多客户的TCP链接。线程将阻塞以等待数据的到达。一旦任何一个链接上有数据到达，线程就被唤醒，并处理请求和发送响应。然后它再次被阻塞，等待另一个连接上更多数据的到达。

编写一个单线程并发服务器的关键是通过在操作系统原语`select` 中使用异步`I/O`。一个服务器为它必须管理的每一个连接创建一个套接子，然后调用`selcet` 等到任一连接上的数据的到达。`select` 可在所有的socket上等待`I/O`，它也同时能等待新的连接。

## 线程结构

单线程服务器必须完成主线程和从线程双方的职责。它维护一组socket，组中的master socket绑定到主线程服务等待接收新的连接。组中的其他每个socket 都对应一个连接，交由从线程处理请求。将这组socket传递给`select`，等待任何一个socket上的活动。

单线程服务器使用描述符来区分主线程和从线程的操作。

* msock 准备就绪，主线程操作：调用`accept`获得新连接
* ssock 准备就绪，从线程操作：调用`read ` 新请求

## 数据共享

在单线程实现中，一个执行线程管理多个连接，通过异步`I/O`达到表面上的并发性。服务器反复的在多个连接之间共享数据。

应用程序必须共享数据或者对每个请求的处理时间必须很低，只要在这种情况下，服务器的实现方案相对于多线程就是可取的。

## 示例

`TCPmechod.c` 实现了一个单线程的`ECHO`并发服务器。

测试方式

1. make
2. 服务器端：`A./main 12344i`
3. 客户端：`telnet 127.0.0.1 12344`

支持多个用户连入，实现并发作业。

## 参考

《Iternetworking with TCP/IP 》
